# ovn-northd-ddlog Design Notes

`ovn-northd-ddlog` is a port of the OVN northd controller to
[DDlog](https://github.com/vmware/differential-datalog).  This
document describes its design and usage.

## Other resources

- [DDlog tutorial](https://github.com/vmware/differential-datalog)
- [DDlog for OVN developers tutorial](https://www.youtube.com/watch?v=P-1VwZNNpAc&t=2098s)

## Building and using ovn-northd-ddlog

### Building

To build OVS and OVN with `ovn-northd-ddlog` enabled:

- Make sure that you have the latest version of DDlog installed.  Follow
  [DDlog installation instructions](https://github.com/vmware/differential-datalog#installing-from-sources)
  to install DDlog from source or binary release.

- Make sure that you are on the `ddlog-dev` branch of the
  [https://github.com/ovn-org/ovn](https://github.com/ovn-org/ovn) repo.

- Configure OVS with `ovn-north-ddlog` enabled:
  ```
  ./configure --with-ddlog=<path to differential-datalog directory>/lib
  ```

- Run `make` as you normally would to build OVS and OVN.  (Unfortunately
  this takes much longer than normal OVS builds due to the Rust compiler
  being slow, typically ~7 minutes on a laptop).

There are two additional `configure` options related to DDlog:

- `--enable-ddlog-northd-cli` tells the build system to compile a standalone
  DDlog executable that can be used to replay recorded DDlog execution
  (see the [debugging guide](./debugging.md#record-and-replay-ddlog-execution)
  for details).  This option is disabled by default because it further
  increases DDlog build time by nearly a factor of two.

- `--enable-ddlog-fast-build` speeds up DDlog compilation by a factor of two
  by disabling some Rust compiler optimizations.  This option will result in a
  much slower `ovn-northd-ddlog` executable, therefore it should not be used
  for production builds of during profiling.

### Switching between DDlog and C versions of `northd`

If you configured OVS with `--with-ddlog`, two northd executables will be
generated: `ovn-norhtd` -- the "normal" C implementation of northd, and
`ovn-northd-ddlog` -- the DDlog version.  When using the `ovn-ctl` script to
start OVN, use the `--ovn-northd-ddlog=yes|no` switch
to choose between the two implementations (the default is `no`).

### Upgrading DDlog

The DDlog language and libraries are still evolving rapidly, and you may
occasionally have to update to the latest version that resolves a bug
or adds a feature needed by `ovn-northd-ddlog`.  To do so, pull
the latest `master` branch of DDlog and run `stack install` (or simply
download and unzip the latest binary release).

In the OVS directory, run `make clean` to force recompilation of
`ovn-northd-ddlog`.

### Tests

The OVN test harness has been modified to run all OVN tests with both versions
of northd, e.g., running `make check -j6 TESTSUITEFLAGS="-k ovn"` will produce
something like:

```
## ------------------------------- ##
## openvswitch 2.11.90 test suite. ##
## ------------------------------- ##

<skipped>

OVN end-to-end tests (ovn-northd)

2707: ovn -- 3 HVs, 1 LS, 3 lports/HV                 ok
<skipped>

OVN end-to-end tests (ovn-northd-ddlog)

2780: ovn -- 3 HVs, 1 LS, 3 lports/HV                 ok
<skipped>
```

### Debugging and profiling

See the [debugging guide](./debugging.md) for tips on debugging and
profiling `ovn-northd-ddlog`.

## Overview of `ovn-northd-ddlog` source code

The `ovn-northd-ddlog` implementation consists of the following source files
in the `ovn/northd` directory.

- `ovn.dl` and `ovn.rs` - DDlog declarations of various OVN and OVS-specific
  datatypes and DDlog bindings for C functions exported by `libovn` and
  `libopenvswitch` static libraries.

- `lswitch.dl` - computes intermediate relations for working with logical
  switches and ports.

- `lrouter.dl` - computes intermediate relations for working with logical
  routers and logical router ports.

- `multicast.dl` - computes intermediate relations for generating logical
  flows to handle IP multicast. These relations are twofold: switch/router
  multicast configurations and per datapath IGMP groups aggregated from
  `OVN-Southbound` `IGMP_Group` records.

- `ipam.dl` - IP address management (IPAM) and MAC address management (MACAM)
  logic

- `helpers.dl` - several useful helper relations used by multiple other modules.

- `OVN_Northbound.dl`, `OVN_Southbound.dl` - files autogenerated by the
  `ovsdb2ddlog` tool from `ovn/ovn-nb.ovsschema` and `ovn/ovn-sb.ovsschema`
  respectively, containing DDlog declaration of OVSDB tables and some additional
  plumbing to compute deltas between input and output relations.

- `ovn_northd.dl` - the main DDlog program that computes all output relations,
  including logical flows.

- `ovn-northd-ddlog.c` - the C program that provides the `main()` function for
  `ovn-northd-ddlog`.  The program subscribes to updates from Northbound and
  Southbound databases.  The main loop of the program receives OVSDB update
  notifications in the OVSDB JSON format and passes them directly to the DDlog
  API.  It then extracts changes to Northbound and Southbound tables computed
  by DDlog, also in the JSON format and sends them them as commands to OVSDB.

## TODO: detailed description of each module

## Adding a new OVN feature to `ovn-northd-ddlog`

See the [new feature tutorial](./new-feature-tutorial.md) for step by step
instructions on how to add a new feature to `ovn-northd-ddlog`.
